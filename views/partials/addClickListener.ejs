<script>
  const addClickListener = (target, route, method, payload, ...inputs) => {
    const attach = handler =>
      target.addEventListener('click', handler, { once: true });

    const handler = async event => {
      try {
        for (const input of inputs) {
          if (!input.reportValidity()) return;
          payload[input.name] = input.value;
        }

        const response = await fetch(`/api/${route}`, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (response.ok) location.reload();
        else throw new HTTPError;
      } catch (err) {
        console.error(err);
        alert(err instanceof HTTPError ? 'Operation failed.' : 'Network error');
        attach(handler);
      }
    };
    attach(handler);

    for (const input of inputs)
      input.addEventListener('keyup', event => {
        if (event.key === 'Enter') target.click();
      });
  }
</script>
