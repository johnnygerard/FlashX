<!DOCTYPE html>
<html lang="en">

<head>
  <%- include('/metadata', { title: 'Register' }) %>
  <%- include('/formStyle') %>
  <style>
    form {
      margin: auto;
      width: fit-content;
    }

  </style>
</head>

<body>
  <%- include('/nav', { authenticated }) %>

  <main>
    <%- include('/logo') %>

    <form action="/register" method="post" class="form">
      <label for="username">Username</label>
      <input id="username" name="username" autocomplete="username" required
          autofocus maxlength="128" pattern="[!-~]*">
      <script type="module">
        const username = document.getElementById('username');

        username.addEventListener('input', event => {
          const validity = username.validity;
          const message =
            validity.tooLong ? 'Maximum length is 128' :
              validity.patternMismatch ? `Forbidden:
                spaces
                control characters
                non-ascii characters` : '';

          username.setCustomValidity(message);
        });
      </script>
      <label for="password">Password</label>
      <template id="pwdContainer">
        <style>
          :host {
            margin-bottom: 2em;
            position: relative;
          }

          ::slotted(*) {
            padding-right: 4em !important;
          }

          button {
            all: unset;
            cursor: pointer;
            padding: 0.5em 1em;
            position: absolute;
            right: 0;
            top: 50%;
            transform: translate(0, -50%);
          }

          button:focus-visible {
            outline: 2px solid black;
            outline-offset: -0.5em;
            border-radius: 1em;
          }

          img {
            height: 2em;
            width: 2em;
          }

          img:not([hidden]) {
            display: block;
          }

        </style>
        <slot name="input"></slot>
        <button type="button">
          <img src="eye-icon-show-32px.png" alt="show password" width="32"
              height="32">
          <img src="eye-icon-hide-32px.png" alt="hide password" width="32"
              height="32" hidden>
        </button>
      </template>
      <script type="module">
        class CustomElement extends HTMLElement {
          constructor() {
            super();
            const shadowRoot = this.attachShadow({ mode: 'closed' });
            const fragment = document.getElementById('pwdContainer').content;

            shadowRoot.appendChild(fragment);

            const button = shadowRoot.querySelector('button');
            const eyeIconShow = button.querySelector(':not([hidden])');
            const eyeIconHide = button.querySelector('[hidden]');

            button.addEventListener('click', event => {
              if (password.type === 'password') {
                password.type = 'text';
                eyeIconShow.style.display = 'none';
                eyeIconHide.style.display = 'block';
              } else {
                password.type = 'password';
                eyeIconShow.style.display = 'block';
                eyeIconHide.style.display = 'none';
              }
            });
          }
        }

        customElements.define('x-password', CustomElement);
      </script>
      <x-password>
        <input id="password" type="password" name="password" slot="input"
            autocomplete="new-password" minlength="11"
            pattern="(?=.*?\d)(?=.*?[a-z])(?=.*?[A-Z])(?=.*?[!-/:-@[-`{-~])[!-~]*"
            maxlength="128" required>
      </x-password>
      <script type="module">
        const password = document.getElementById('password');

        password.addEventListener('input', event => {
          const validity = password.validity;
          const message =
            validity.tooShort ? 'Minimum length is 11' :
              validity.tooLong ? 'Maximum length is 128' :
                validity.patternMismatch ? `Required:
        1 small letter
        1 capital letter
        1 digit
        1 symbol
        
        Forbidden:
        spaces
        control characters
        non-ascii characters` : '';

          password.setCustomValidity(message);
        });
      </script>
      <% for (const { message } of flash) { %>
      <p class="message"><strong><%= message %></strong></p>
      <% } %>
      <button class="positiveAction">Create account</button>
      <p id="link">Already registered? <a href="/">Log in</a></p>
    </form>
  </main>

</body>

</html>
